<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link rel="next" href="Ocb_stubblr_topkg.html">
<link rel="Up" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Ocb_stubblr" rel="Chapter" href="Ocb_stubblr.html">
<link title="Ocb_stubblr_topkg" rel="Chapter" href="Ocb_stubblr_topkg.html"><link title="Intro" rel="Section" href="#intro">
<link title="Interface" rel="Section" href="#interface">
<link title="Examples" rel="Section" href="#examples">
<link title="1. Using .clib files" rel="Subsection" href="#2_1">
<link title="2. pkg-config" rel="Subsection" href="#2_2">
<link title="3. Multi-lib" rel="Subsection" href="#multilib">
<link title="Utilities" rel="Subsection" href="#utilities">
<link title="OS and machine detection" rel="Subsection" href="#2_OSandmachinedetection">
<link title="Basic integration" rel="Subsection" href="#2_Basicintegration">
<link title="pkg-config" rel="Subsection" href="#2_pkgconfig">
<link title="In-tree executables" rel="Subsection" href="#2_Intreeexecutables">
<link title="Multi-lib" rel="Subsection" href="#2_Multilib">
<link title="Mirage" rel="Subsection" href="#2_Mirage">
<link title="Composition" rel="Subsection" href="#2_Composition">
<title>Ocb_stubblr</title>
</head>
<body>
<div class="navbar">&nbsp;<a class="up" href="index.html" title="Index">Up</a>
&nbsp;<a class="post" href="Ocb_stubblr_topkg.html" title="Ocb_stubblr_topkg">Next</a>
</div>
<h1>Module <a href="type_Ocb_stubblr.html">Ocb_stubblr</a></h1>

<pre><span class="keyword">module</span> Ocb_stubblr: <code class="code"><span class="keyword">sig</span></code> <a href="Ocb_stubblr.html">..</a> <code class="code"><span class="keyword">end</span></code></pre><div class="info module top">
OCamlbuild plugin for C stubs
<p>

    See the <a href="Ocb_stubblr.html#intro">Intro</a>, <a href="Ocb_stubblr.html#interface">Interface</a> or <a href="Ocb_stubblr.html#examples">Examples</a>.<br>
</div>
<hr width="100%">
<br>
<h1 id="intro">Intro</h1>
<p>

    <code class="code">ocb-stubblr</code> helps dealing with C libraries that are built as part of an
    OCaml project. It is especially useful for libraries of OCaml primitives
    (stubs).
<p>

    Most of the plugin consists of new tags that can be applied to files, and
    new rules that are activated when OCamlbuild tries to build certain targets.
    In order to enable these, <a href="Ocb_stubblr.html#VALinit"><code class="code"><span class="constructor">Ocb_stubblr</span>.init</code></a> needs to be called from
    <code class="code"><span class="constructor">Ocamlbuild_plugin</span>.dispatch</code>:
<p>

<pre class="codepre"><code class="code"><span class="keyword">let</span>&nbsp;()&nbsp;=&nbsp;<span class="constructor">Ocamlbuild_plugin</span>.dispatch&nbsp;<span class="constructor">Ocb_stubblr</span>.init</code></pre>
<p>

    The plugin helps with three aspects of building C stubs:
<p>

    <h2 id="2_1">1. Using <code class="code">.clib</code> files</h2>
<p>

    <code class="code">stubblr</code> modifies <code class="code">.clib</code> build rules to automatically search for, and
    require, project-local headers that the C source files <code class="code"><span class="keywordsign">#</span><span class="keyword">include</span></code>.
<p>

    Furthermore, it provides the tag <code class="code">link_stubs()</code>. This tag acts on OCaml
    archives, and records the link flags needed for linking with the given C
    library. The parameter is assumed to be a <code class="code">.clib</code> file in the same project.
<p>

    For example, adding
<pre class="codepre"><code class="code">&lt;foo.cm{,x}a&gt;:&nbsp;link_stubs(path/libbar)</code></pre>
    records the link flag <code class="code">-lbar</code> in <code class="code">foo.cm{,x}a</code>. Assuming that the C
    libraries described by <code class="code">path/libbar.clib</code> are installed, this causes any
    final executables that use the archive <code class="code">foo.cmxa</code> (resp. <code class="code">foo.cma</code>) to link
    to <code class="code">libbar.a</code> (resp <code class="code">dllbar.so</code>). This is useful if <code class="code"><span class="constructor">Foo</span></code> provides the
    interface to the C primitives in <code class="code">libbar</code>.
<p>

    Another feature is the automatic addition of <code class="code">use_&lt;lib&gt;</code> tags for every
    <code class="code">&lt;lib&gt;.mllib</code>. OCaml sources tagged with this tag are built against the
    archive <code class="code">&lt;lib&gt;.cm{,x}a</code>, instead of using its constituent <code class="code">cm{o,x}</code> through
    <code class="code"><span class="keyword">include</span></code> tags. This means that the in-tree executables inherit the link
    flags (as introduced, for example, above), and are correctly linked against
    the in-tree C libraries.
<p>

    Finally, the tags <code class="code">ccopt</code> and <code class="code">cclib</code>, which were introduced in OCamlbuild
    0.9.3, are added if the plugin is used with an older version. This allows
    setting these options directly from <code class="code">_tags</code> with any OCamlbuild version.
<p>

    <h2 id="2_2">2. <code class="code">pkg-config</code></h2>
<p>

    <code class="code">stubblr</code> provides the tag <code class="code">pkg-config()</code>.
<p>

    Tagging objects with <code class="code">pkg-config(package)</code> will query <code class="code">pkg-config</code> for the
    <code class="code">package</code>, and:
<p>

    <OL>
<li>add the C flags (<code class="code">pkg-config --cflags</code>) to the compilation of tagged C
       sources;</li>
<li>add the link flags (<code class="code">pkg-config --libs</code>) to the linking step of tagged C
       libraries; and</li>
<li>record those link flags in the tagged OCaml archives.</li>
</OL>

<p>

    For example
<pre class="codepre"><code class="code">&lt;src/*.{c,cma,cmxa}&gt;:&nbsp;pkg-config(sdl2)</code></pre>
    will add the flags needed to compile against SDL2 when compiling C sources,
    and record the flags needed to link the final executables against <code class="code">libSDL2.so</code>
    to the native and bytecode archives.
<p>

    The full syntax of the tag is <code class="code">pkg-config(package[ relax][ &lt;params&gt;])</code> where
    <code class="code">&lt;params&gt;</code> is a space-separated combination of any of: <code class="code">cflags</code>, <code class="code">libs</code>,
    <code class="code">static</code>.
<p>

    <code class="code">relax</code> will ignore the package if it is not found. Otherwise, the build
    will abort.
<p>

    <code class="code">cflags</code> will query <code class="code">--cflags</code>.
<p>

    <code class="code">libs</code> will query <code class="code">--libs</code>.
<p>

    <code class="code">static</code> will query <code class="code">--libs --static</code> (and has precedence over <code class="code">libs</code>).
<p>

    If none of <code class="code">cflags</code>, <code class="code">libs</code> and <code class="code">static</code> are present, <code class="code">cflags libs</code> is
    assumed. Thus <code class="code">pkg-config(pkg relax)</code> will query <code class="code">--cflags</code> and <code class="code">--libs</code>,
    and ignore the error if <code class="code">pkg</code> is not installed; <code class="code">pkg-config(pkg cflags)</code>
    will query only the <code class="code">--cflags</code>; while <code class="code">pkg-config(pkg static)</code> will query
    only <code class="code">--libs --static</code>.
<p>

    <b>Note</b> <code class="code">.pc</code> files in the current Opam switch take precedence; see
    <a href="Ocb_stubblr.Pkg_config.html"><code class="code"><span class="constructor">Pkg_config</span></code></a>.
<p>

    <h2 id="multilib">3. Multi-lib</h2>
<p>

    Sometimes it can be desirable to compile a C library in several ways, e.g.
    with different compilation options, and install all of the versions.
<p>

    For any file <code class="code">path/libstub.clib</code>, <code class="code">stubblr</code> introduces the rules to build
    <code class="code"><span class="constructor">X</span>/&lt;<span class="constructor">TARGET</span>&gt;/path/libstub+&lt;<span class="constructor">TARGET</span>&gt;.clib</code>, where <code class="code">&lt;<span class="constructor">TARGET</span>&gt;</code> is an arbitrary
    name. The new library is built from the same sources, but it doesn't inherit
    any of the tags directly applied to the original <code class="code">.clib</code> and its products.
    Instead, the files <code class="code"><span class="constructor">X</span>/&lt;<span class="constructor">TARGET</span>&gt;/**/*</code> can be marked with a separate set of
    tags, causing them to be compiled and/or linked with different options.
<p>

    As a special case, there are pre-defined targets for different MirageOS
    runtimes (currently <code class="code">mirage-xen</code> and <code class="code">mirage-freestanding</code>). These are
    automatically tagged with the required compilation options.
<p>

    <b>Note</b> If your paths already contain <code class="code">+</code>, OCamlbuild solver is likely to
    get confused. Assume that the meaning of <code class="code">+</code> in paths has been hijacked by
    <code class="code">ocb-stubblr</code>. The new semantics of <code class="code">+</code> is accessible only through
    transcendental hermenautics.<br>
<br>
<h1 id="interface">Interface</h1><br>

<pre><span id="TYPEocb_hook"><span class="keyword">type</span> <code class="type"></code>ocb_hook</span> = <code class="type">Ocamlbuild_plugin.hook -> unit</code> </pre>


<pre><span id="TYPEpath"><span class="keyword">type</span> <code class="type"></code>path</span> = <code class="type">Ocamlbuild_plugin.Pathname.t</code> </pre>


<pre><span id="VALinit"><span class="keyword">val</span> init</span> : <code class="type">?incdirs:bool -> ?mllibs:<a href="Ocb_stubblr.html#TYPEpath">path</a> list -> <a href="Ocb_stubblr.html#TYPEocb_hook">ocb_hook</a></code></pre><div class="info ">
<code class="code">init ?incdirs ?paths</code> initializes the plugin.
<p>

    <code class="code">incdirs</code> causes <a href="Ocb_stubblr.html#VALinclude_include_dirs"><code class="code">include_include_dirs</code></a> to be
    called on initialisation. Defaults to <code class="code"><span class="keyword">true</span></code>.
<p>

    <code class="code">mllibs</code> are passed to <a href="Ocb_stubblr.html#VALocaml_libs"><code class="code">ocaml_libs</code></a>, to detect any
    <code class="code">&lt;lib&gt;.mllib</code> files and enable their corresponding <code class="code">use_&lt;lib&gt;</code> tags.
    Use <code class="code">[]</code> to disable. Defaults to <code class="code">[<span class="string">"."</span>]</code>.<br>
</div>
<br>
<h2 id="utilities">Utilities</h2><br>

<pre><span id="VALocaml_libs"><span class="keyword">val</span> ocaml_libs</span> : <code class="type">?mllibs:<a href="Ocb_stubblr.html#TYPEpath">path</a> list -> <a href="Ocb_stubblr.html#TYPEocb_hook">ocb_hook</a></code></pre><div class="info ">
<code class="code">ocaml_libs ~mllibs</code> calls <code class="code"><span class="constructor">Ocamlbuild_plugin</span>.ocaml_lib</code> on every <code class="code">.mllib</code>
    found in <code class="code">mllibs</code>. It's a shortcut to enable <code class="code">use_&lt;lib&gt;</code> tag for every
    <code class="code">&lt;lib&gt;.mllib</code> in the project.
<p>

    <code class="code">mllibs</code> is a list of files or directories. Directories in the list are
    searched recursively. <code class="code">mllibs</code> defaults to <code class="code">[<span class="string">"."</span>]</code>.<br>
</div>

<pre><span id="VALinclude_include_dirs"><span class="keyword">val</span> include_include_dirs</span> : <code class="type"><a href="Ocb_stubblr.html#TYPEocb_hook">ocb_hook</a></code></pre><div class="info ">
<code class="code">include_include_dirs</code> will add <code class="code">-<span class="constructor">I</span> dir</code> when linking OCaml programs for
    every <code class="code">dir</code> marked as <code class="code"><span class="keyword">include</span></code>.<br>
</div>

<pre><span id="VALccopt"><span class="keyword">val</span> ccopt</span> : <code class="type">?tags:string list -> string -> <a href="Ocb_stubblr.html#TYPEocb_hook">ocb_hook</a></code></pre><div class="info ">
<code class="code">ccopt tags options</code> adds <code class="code">-ccopt options</code> when compiling the C sources
    tagged with <code class="code">~tags</code>.
<p>

    <code class="code">tags</code> defaults to <code class="code">[]</code>.<br>
</div>

<pre><span id="VALcclib"><span class="keyword">val</span> cclib</span> : <code class="type">?tags:string list -> string -> <a href="Ocb_stubblr.html#TYPEocb_hook">ocb_hook</a></code></pre><div class="info ">
<code class="code">cclib tags options</code> adds <code class="code">-cclib options</code> when linking the C libraries
    tagged with <code class="code">~tags</code>.
<p>

    <code class="code">tags</code> defaults to <code class="code">[]</code>.<br>
</div>

<pre><span id="VALldopt"><span class="keyword">val</span> ldopt</span> : <code class="type">?tags:string list -> string -> <a href="Ocb_stubblr.html#TYPEocb_hook">ocb_hook</a></code></pre><div class="info ">
<code class="code">ldopt tags options</code> adds <code class="code">-ldopt options</code> when linking the C libraries
    tagged with <code class="code">~tags</code>.
<p>

    <code class="code">tags</code> defaults to <code class="code">[]</code>.<br>
</div>

<pre><span id="VALafter_rules"><span class="keyword">val</span> after_rules</span> : <code class="type">(unit -> unit) -> <a href="Ocb_stubblr.html#TYPEocb_hook">ocb_hook</a></code></pre><div class="info ">
<code class="code">after_rules f</code> is <code class="code"><span class="keyword">function</span> <span class="constructor">After_rules</span> <span class="keywordsign">-&gt;</span> f () <span class="keywordsign">|</span> _ <span class="keywordsign">-&gt;</span> ()</code>.<br>
</div>

<pre><span id="VALdispatchv"><span class="keyword">val</span> dispatchv</span> : <code class="type"><a href="Ocb_stubblr.html#TYPEocb_hook">ocb_hook</a> list -> unit</code></pre><div class="info ">
<code class="code">dispatchv hooks</code> is a shortcut for registering several
    <a href="Ocb_stubblr.html#TYPEocb_hook">ocb_hooks</a>.
<p>

    It is equivalent to <code class="code"><span class="constructor">Ocamlbuild_plugin</span>.dispatch hookf</code> where <code class="code">hookf</code> is a
    function that applies each hook from <code class="code">hooks</code> in order.<br>
</div>

<pre><span id="VAL(&)"><span class="keyword">val</span> (&amp;)</span> : <code class="type"><a href="Ocb_stubblr.html#TYPEocb_hook">ocb_hook</a> -> <a href="Ocb_stubblr.html#TYPEocb_hook">ocb_hook</a> -> <a href="Ocb_stubblr.html#TYPEocb_hook">ocb_hook</a></code></pre><div class="info ">
<code class="code">h1 <span class="keywordsign">&amp;</span> h2</code> is a hook combining <code class="code">h1</code> and <code class="code">h2</code>.<br>
</div>

<pre><span class="keyword">module</span> <a href="Ocb_stubblr.Pkg_config.html">Pkg_config</a>: <code class="code"><span class="keyword">sig</span></code> <a href="Ocb_stubblr.Pkg_config.html">..</a> <code class="code"><span class="keyword">end</span></code></pre><div class="info">
Query <code class="code">pkg-config</code>.
</div>
<br>
<h2 id="2_OSandmachinedetection">OS and machine detection</h2>
<p>

    These utilities are included because it is sometimes necessary to change
    options for building C libraries depending on the host OS and architecture.<br>

<pre><span id="TYPEos"><span class="keyword">type</span> <code class="type"></code>os</span> = <code class="type">[ `AIX<br>       | `Cygwin of string<br>       | `Darwin<br>       | `DragonFly<br>       | `FreeBSD<br>       | `HP_UX<br>       | `Haiku<br>       | `Hurd<br>       | `Interix<br>       | `KFreeBSD<br>       | `Linux<br>       | `Mingw of string<br>       | `Minix<br>       | `NetBSD<br>       | `OpenBSD<br>       | `QNX<br>       | `SunOS<br>       | `UNKNOWN of string<br>       | `Uwin of string ]</code> </pre>
<div class="info ">
A selection of popular operating systems.<br>
</div>


<pre><span id="TYPEmachine"><span class="keyword">type</span> <code class="type"></code>machine</span> = <code class="type">[ `ARMv6 | `ARMv7 | `UNKNOWN of string | `x86 | `x86_64 ]</code> </pre>
<div class="info ">
A selection of machine architectures supported by OCaml.<br>
</div>


<pre><span id="VALos"><span class="keyword">val</span> os</span> : <code class="type">unit -> <a href="Ocb_stubblr.html#TYPEos">os</a></code></pre><div class="info ">
<code class="code">os ()</code> is the normalized result of <code class="code">uname -s</code>.<br>
</div>

<pre><span id="VALmachine"><span class="keyword">val</span> machine</span> : <code class="type">unit -> <a href="Ocb_stubblr.html#TYPEmachine">machine</a></code></pre><div class="info ">
<code class="code">machine ()</code> is the normalized result of <code class="code">uname -m</code>.<br>
</div>
<br>
<h1 id="examples">Examples</h1>
<p>

    Assume a project laid out like the following:
<p>

    Project dir:
<pre class="codepre"><code class="code">./myocamlbuild.ml
./_tags
./src/foo.ml
./src/stubs.c
./src/extra/defs.h
./src/libstubs.clib
./src/foo.mllib
./exe/demo.ml</code></pre>
<p>

    The content of <code class="code">src/foo.mllib</code>:
<pre class="codepre"><code class="code"><span class="constructor">Foo</span></code></pre>
<p>

    The content of <code class="code">src/libstubs.clib</code>:
<pre class="codepre"><code class="code">stubs.o</code></pre>
<p>

    The content of <code class="code">_tags</code>:
<pre class="codepre"><code class="code">&lt;src&gt;:&nbsp;<span class="keyword">include</span></code></pre>
<p>

    <h2 id="2_Basicintegration">Basic integration</h2>
<p>

    Initialize the plugin from <code class="code">myocamlbuild.ml</code>:
<pre class="codepre"><code class="code"><span class="keyword">let</span>&nbsp;()&nbsp;=&nbsp;<span class="constructor">Ocamlbuild_plugin</span>.dispatch&nbsp;<span class="constructor">Ocb_stubblr</span>.init</code></pre>
<p>

    The file <code class="code">src/extra/defs.h</code> will be automatically used when compiling
    <code class="code">src/stubs.c</code>, if needed.
<p>

    Adding the tag
<pre class="codepre"><code class="code">&lt;src/*.cm{,x}a&gt;:&nbsp;link_stubs(src/libstubs)</code></pre>
    will record the link flag <code class="code">-lstubs</code> in <code class="code">foo.cm{,x}a</code>, causing executables
    that use them to link against <code class="code">libstubs.a</code>/<code class="code">dllstubs.so</code>.
<p>

    <h2 id="2_pkgconfig"><code class="code">pkg-config</code></h2>
<p>

    Adding the tag
<pre class="codepre"><code class="code">&lt;src/*.{c,cma,cmxa}&gt;:&nbsp;pkg-config(sdl2&nbsp;relax)</code></pre>
    will cause <code class="code">stubs.c</code> to be compiled with C flags from <code class="code">sdl2.pc</code>, and
    <code class="code">foo.cm{,x}a</code> to record the link flags.
<p>

    If <code class="code"><span class="constructor">SDL2</span></code> is not installed, <code class="code">relax</code> will cause it to be ignored.
<p>

    <h2 id="2_Intreeexecutables">In-tree executables</h2>
<p>

    To build <code class="code">demo.native</code> and/or <code class="code">demo.byte</code>, <code class="code">_tags</code> needs to contain
<p>

<pre class="codepre"><code class="code">&lt;exe/*&gt;:&nbsp;use_foo</code></pre>
<p>

    causing <code class="code">demo.{native,byte}</code> to build against <code class="code">foo.cm{,x}a</code> and inherit its
    link flags. The archive, in turn, contains flags for linking to the stub
    library (<code class="code">link_stubs()</code>), and linking to <code class="code"><span class="constructor">SDL2</span></code> (<code class="code">pkg-config()</code>).
<p>

    <h2 id="2_Multilib">Multi-lib</h2>
<p>

    Invoking <code class="code">ocamlbuild <span class="constructor">X</span>/fnord/src/libstubs+fnord.a</code> will build
    <code class="code">libstubs+fnord.a</code>.
<p>

    If <code class="code">_tags</code> contains
<pre class="codepre"><code class="code">&lt;src/*.c&gt;:&nbsp;ccopt(-flub)
&lt;<span class="constructor">X</span>/fnord/**/*.c&gt;:&nbsp;ccopt(-<span class="constructor">DA</span>)</code></pre>
<p>

    then <code class="code">libstubs+fnord.a</code> will <em>not</em> be compiled with <code class="code">-flub</code>. Instead, it
    will be compiled with the pre-processor symbol <code class="code"><span class="constructor">A</span></code> defined.
<p>

    <h2 id="2_Mirage">Mirage</h2>
<p>

    If using <code class="code"><span class="constructor">Topkg</span></code>, register the <code class="code">.clib</code> file using
    <a href="Ocb_stubblr_topkg.html#VALmirage"><code class="code"><span class="constructor">Ocb_stubblr_topkg</span>.mirage</code></a>.
<p>

<pre class="codepre"><code class="code"><span class="constructor">Pkg</span>.describe&nbsp;...&nbsp;@&nbsp;<span class="keyword">fun</span>&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;...
&nbsp;&nbsp;<span class="constructor">Ok</span>&nbsp;[&nbsp;<span class="constructor">Pkg</span>.clib&nbsp;<span class="string">"path/to/libstubs.clib"</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ocb_stubblr_topkg</span>.mirage&nbsp;<span class="string">"path/to/libstubs.clib"</span>]</code></pre>
<p>

    Otherwise, arrange for building and installation of
    <code class="code"><span class="constructor">X</span>/&lt;<span class="constructor">TARGET</span>&gt;/path/<span class="keyword">to</span>/libstubs+&lt;<span class="constructor">TARGET</span>&gt;.a</code> for all MirageOS <code class="code"><span class="constructor">TARGET</span></code>s.
<p>

    Use of these alternate archives is a matter of MirageOS.
<p>

    <h2 id="2_Composition">Composition</h2>
<p>

<pre class="codepre"><code class="code"><span class="keyword">let</span>&nbsp;myhook&nbsp;=&nbsp;<span class="keyword">function</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">After_rules</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;...
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;...</code></pre>
<p>

<pre class="codepre"><code class="code"><span class="keyword">let</span>&nbsp;()&nbsp;=&nbsp;<span class="constructor">Ocb_stubblr</span>.(dispatchv&nbsp;[init;&nbsp;myhook])</code></pre>
<p>

<pre class="codepre"><code class="code"><span class="keyword">let</span>&nbsp;()&nbsp;=&nbsp;dispatch&nbsp;<span class="constructor">Ocb_stubblr</span>.(init&nbsp;<span class="keywordsign">&amp;</span>&nbsp;myhook)</code></pre><br>
</body></html>